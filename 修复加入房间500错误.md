# 修复加入房间 500 错误

## 问题分析

错误发生在用户尝试加入房间时：
```
GET /rest/v1/rooms?select=*&code=eq.2EYCF9 500
```

**根本原因：**
1. 用户需要先查询房间（通过 code）才能加入
2. 但当前的 RLS 策略要求用户必须是成员才能查看房间
3. 形成"先有鸡还是先有蛋"的问题

## 解决方案

### 方案：允许所有认证用户查看房间

**理由：**
- `code` 本身就是公开的（用于分享和加入）
- 用户只能通过 `code` 查询，不能列出所有房间
- 这是加入流程的必要步骤

**安全性：**
- 虽然允许查看房间信息，但：
  - 用户只能通过已知的 `code` 查询
  - 不能批量查询所有房间
  - `code` 是 6 位随机码，不容易猜测
  - 只有 host 可以更新房间状态

## 执行步骤

### 第一步：执行修复脚本

1. **登录 Supabase Dashboard**
2. **打开 SQL Editor**
3. **执行文件：** `database/fix_join_room_final.sql`

这个脚本会：
- 删除现有的 SELECT 策略
- 创建新策略，允许所有认证用户查看房间

### 第二步：验证

执行后，在 SQL Editor 中运行：

```sql
-- 查看策略
SELECT policyname, cmd 
FROM pg_policies 
WHERE tablename = 'rooms';
```

应该看到：
- `Users can view rooms they are in` (SELECT) - 允许所有认证用户查看
- `Users can create rooms` (INSERT)
- `Hosts can update own rooms` (UPDATE)

### 第三步：测试

1. 刷新应用页面
2. 尝试加入房间
3. 应该不再有 500 错误

## 如果还有问题

### 检查用户是否已登录

在浏览器控制台执行：

```javascript
// 检查 Supabase 用户
const { data: { user } } = await supabase.auth.getUser();
console.log('当前用户:', user);
```

如果没有用户，需要先登录。

### 检查策略是否正确应用

在 Supabase SQL Editor 中执行：

```sql
-- 查看详细的策略信息
SELECT 
  policyname,
  cmd,
  qual,
  with_check
FROM pg_policies 
WHERE tablename = 'rooms';
```

### 检查是否有其他错误

查看 Supabase Dashboard > Logs > Postgres Logs，查看详细的错误信息。
