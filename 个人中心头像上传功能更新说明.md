# 个人中心头像上传功能更新说明

## 更新概览

### 问题1：中文翻译缺失
✅ **已修复**：合并了翻译文件中重复的profile字段，添加了完整的中英文翻译。

### 问题2：头像上传功能
✅ **已实现**：
- 移除了URL输入框
- 添加了图片上传功能
- 实现了图片自动缩放和压缩
- 图片自动适配头像框（200x200像素）

---

## 主要改动

### 1. 数据库架构更新 (`database/schema.sql`)

```sql
-- 用户资料表保持不变，avatar_url现在存储上传图片的公开URL
CREATE TABLE IF NOT EXISTS user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT,
  display_name TEXT,
  avatar_url TEXT,  -- 现在存储 Supabase Storage 的公开URL
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 新增 Storage Bucket 配置
INSERT INTO storage.buckets (id, name, public)
VALUES ('avatars', 'avatars', true)
ON CONFLICT (id) DO NOTHING;

-- 新增 Storage 访问策略
-- 1. 用户可以上传自己的头像
-- 2. 用户可以更新自己的头像
-- 3. 用户可以删除自己的头像
-- 4. 所有人可以查看公开的头像
```

### 2. 翻译文件更新

#### 中文 (`public/locales/zh/translation.json`)
```json
{
  "profile": {
    "displayName": "昵称",
    "displayNamePlaceholder": "给自己取个好听的名字",
    "avatar": "头像",
    "uploadAvatar": "上传头像",
    "changeAvatar": "更换头像",
    "avatarHint": "支持 JPG、PNG 格式，文件大小不超过 2MB",
    "save": "保存资料",
    "saving": "保存中...",
    "saveSuccess": "已保存",
    "saveFailed": "保存失败：{{error}}",
    "uploadFailed": "上传失败：{{error}}",
    "fileTooLarge": "文件太大，请选择小于 2MB 的图片",
    "invalidFileType": "不支持的文件格式，请选择 JPG 或 PNG 图片"
  }
}
```

#### 英文 (`public/locales/en/translation.json`)
```json
{
  "profile": {
    "displayName": "Display name",
    "displayNamePlaceholder": "Pick a friendly name",
    "avatar": "Avatar",
    "uploadAvatar": "Upload avatar",
    "changeAvatar": "Change avatar",
    "avatarHint": "JPG or PNG, max 2MB",
    "save": "Save profile",
    "saving": "Saving...",
    "saveSuccess": "Saved",
    "saveFailed": "Save failed: {{error}}",
    "uploadFailed": "Upload failed: {{error}}",
    "fileTooLarge": "File too large. Please choose an image under 2MB",
    "invalidFileType": "Unsupported format. Please choose JPG or PNG"
  }
}
```

### 3. 个人中心页面更新 (`src/components/ProfilePage.jsx`)

#### 新增功能：

1. **图片上传处理**
   ```javascript
   const handleAvatarUpload = async (e) => {
     // 1. 验证文件类型和大小
     // 2. 压缩和缩放图片
     // 3. 上传到Supabase Storage
     // 4. 更新用户资料
   }
   ```

2. **图片自动缩放**
   ```javascript
   const resizeImage = (file, maxWidth = 200, maxHeight = 200, quality = 0.8) => {
     // 使用Canvas API自动缩放图片
     // 保持宽高比
     // 压缩质量80%
   }
   ```

3. **UI改进**
   - 移除了URL输入框
   - 添加了文件选择按钮
   - 实时预览头像
   - 上传进度提示

---

## 使用说明

### Supabase配置步骤

#### 步骤1：执行数据库SQL
在Supabase Dashboard的SQL Editor中执行 `database/schema.sql` 中的完整SQL代码。

#### 步骤2：创建Storage Bucket
两种方式任选其一：

**方式A：通过Dashboard（推荐）**
1. 进入 Supabase Dashboard
2. 点击 Storage
3. 点击 "New bucket"
4. 名称填写：`avatars`
5. 勾选 "Public bucket"
6. 点击创建

**方式B：通过SQL**
```sql
INSERT INTO storage.buckets (id, name, public)
VALUES ('avatars', 'avatars', true)
ON CONFLICT (id) DO NOTHING;
```

详细步骤请参考：`SUPABASE_STORAGE_SETUP.md`

### 用户使用流程

1. 登录应用
2. 进入个人中心
3. 在"基本资料编辑"区域：
   - 输入昵称
   - 点击"上传头像"或"更换头像"按钮
   - 选择图片文件（JPG/PNG，最大2MB）
4. 图片会自动：
   - 缩放到200x200像素
   - 压缩到合适大小
   - 上传到服务器
   - 更新头像显示
5. 点击"保存资料"保存昵称

---

## 技术特性

### 图片处理
- ✅ 自动缩放到200x200像素（保持宽高比）
- ✅ 压缩质量80%
- ✅ Canvas处理，客户端完成
- ✅ 支持JPG和PNG格式

### 安全性
- ✅ 文件类型验证
- ✅ 文件大小限制（2MB）
- ✅ 用户隔离（只能访问自己的头像）
- ✅ RLS策略保护
- ✅ 自动清理旧头像

### 用户体验
- ✅ 实时预览
- ✅ 上传进度提示
- ✅ 错误提示（中英文）
- ✅ 加载失败自动回退到首字母显示
- ✅ 响应式设计

---

## 文件清单

### 修改的文件
1. `database/schema.sql` - 完整数据库架构
2. `public/locales/zh/translation.json` - 中文翻译
3. `public/locales/en/translation.json` - 英文翻译
4. `src/components/ProfilePage.jsx` - 个人中心页面

### 新增的文件
1. `SUPABASE_STORAGE_SETUP.md` - Storage配置指南
2. `个人中心头像上传功能更新说明.md` - 本文档

---

## 测试检查清单

- [ ] 数据库表已创建
- [ ] Storage bucket已创建
- [ ] Storage策略已配置
- [ ] 可以成功上传JPG图片
- [ ] 可以成功上传PNG图片
- [ ] 文件大小验证工作正常
- [ ] 文件类型验证工作正常
- [ ] 头像正确显示
- [ ] 更换头像功能正常
- [ ] 旧头像自动删除
- [ ] 中文界面翻译正确
- [ ] 英文界面翻译正确
- [ ] 错误提示正确显示
- [ ] 移动端显示正常

---

## 常见问题

### Q1: 如何调整头像尺寸？
修改 `ProfilePage.jsx` 中的 `resizeImage` 函数：
```javascript
const resizeImage = (file, maxWidth = 300, maxHeight = 300, quality = 0.8)
```

### Q2: 如何调整文件大小限制？
修改 `ProfilePage.jsx` 中的验证代码：
```javascript
if (file.size > 5 * 1024 * 1024) {  // 改为5MB
  alert(t('profile.fileTooLarge'))
  return
}
```

### Q3: 头像无法显示怎么办？
1. 检查Storage bucket是否创建
2. 检查Storage策略是否正确
3. 检查浏览器控制台错误
4. 确认bucket设置为public

### Q4: 如何支持更多图片格式？
修改文件输入接受类型：
```javascript
<input
  accept="image/jpeg,image/jpg,image/png,image/webp,image/gif"
  // ...
/>
```

并更新验证代码和翻译文本。

---

## 后续优化建议

1. **图片裁剪功能**：添加裁剪工具让用户自定义裁剪区域
2. **多种尺寸支持**：生成多种尺寸的缩略图
3. **进度条**：显示上传进度
4. **拖拽上传**：支持拖拽文件上传
5. **图片预处理**：上传前预览和编辑
6. **CDN加速**：使用CDN加速头像加载

---

## 版本信息

- 更新日期：2026-01-21
- 版本：v1.0
- 兼容性：Supabase v2+
